<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>Gray-Scott Visualizer (Minimal Fade-In)</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icon-192.png" type="image/png">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    html, body { height: 100%; }
    body { margin: 0; background: #000; color: #fff; font-family: system-ui, sans-serif;
           display: flex; flex-direction: column; align-items: center; padding: 16px; }
    canvas { background: #000; width: 100%; max-width: 500px; aspect-ratio: 1 / 1;
             border-radius: 4px; opacity: 0; transition: opacity 1s ease; pointer-events: none; }
    canvas.active { opacity: 1; pointer-events: auto; }
    #controls { display: flex; flex-direction: column; align-items: stretch; width: 100%;
                max-width: 500px; margin-top: 16px; gap: 8px; }
    #lcd, button, label { height: 48px; background: #111; border: 1px solid #444; color: #fff;
                          font-size: 16px; font-family: monospace; display: flex; align-items: center;
                          justify-content: center; white-space: nowrap; cursor: pointer; padding: 0 12px;
                          border-radius: 6px; overflow: hidden; text-overflow: ellipsis; }
    #lcd span { display: inline-block; animation: scroll 10s linear infinite; }
    @keyframes scroll { from { transform: translateX(100%); } to { transform: translateX(-100%); } }
    input[type="file"] { display: none; }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <div id="controls">
    <div id="lcd"><span>NO FILES LOADED</span></div>
    <label id="folderButton">SELECT MUSIC FOLDER</label>
    <button id="playButton">PLAY</button>
    <button id="pauseButton">PAUSE</button>
    <button id="skipButton">NEXT</button>
    <button id="backButton">PREVIOUS</button>
    <input type="file" id="audioInput" accept="audio/*" multiple webkitdirectory>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/meyda/dist/web/meyda.min.js"></script>
  <script>
    let didFullscreen = false;
    async function enterFullscreen() {
      if (didFullscreen) return;
      const el = document.documentElement;
      try {
        if (el.requestFullscreen) await el.requestFullscreen();
        else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
        else if (el.msRequestFullscreen) await el.msRequestFullscreen();
        didFullscreen = true;
      } catch (e) {}
    }

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const size = 500;
    canvas.width = canvas.height = size;
    const imageData = ctx.createImageData(size, size);
    let canvasActivated = false;

    let U = new Float32Array(size * size).fill(1);
    let V = new Float32Array(size * size).fill(0);
    for (let y = size/2 - 16; y < size/2 + 16; y++)
      for (let x = size/2 - 16; x < size/2 + 16; x++)
        V[y*size + x] = 1;

    const du = 0.16, dv = 0.08, feedBase = 0.022, killBase = 0.051;
    let feed = feedBase, kill = killBase;
    let paused = false, playing = false, isSwitching = false;
    let flashFeed = 0, flashKill = 0;
    const pinkNoise = Array(8).fill(0);

    function generatePinkNoise() {
      let total = 0;
      for (let i=0;i<pinkNoise.length;i++){
        if (Math.random() < 1/(1<<i)) pinkNoise[i] = Math.random()*2 - 1;
        total += pinkNoise[i];
      }
      return total/pinkNoise.length;
    }
    function lap(f, x, y){
      return f[((y-1+size)%size)*size+x] + f[((y+1)%size)*size+x] +
             f[y*size + ((x-1+size)%size)] + f[y*size + ((x+1)%size)] -
             4*f[y*size+x];
    }
    function step(){
      const U2 = new Float32Array(U.length), V2 = new Float32Array(V.length);
      const t = performance.now()/1000;
      const pf = generatePinkNoise()*0.0015, pk = generatePinkNoise()*0.0015;
      const f = feedBase + pf + 0.0007*Math.sin(t*Math.PI/10) + flashFeed;
      const k = killBase + pk + 0.0007*Math.cos(t*Math.PI/10) + flashKill;
      flashFeed *= 0.85; flashKill *= 0.85;
      for (let i=0;i<U.length;i++){
        const y = Math.floor(i/size), x = i%size;
        const u=U[i], v=V[i];
        const Lu = lap(U,x,y)*1.2;
        const Lv = lap(V,x,y)*1.2;
        U2[i] = u + (du*Lu - u*v*v + f*(1-u));
        V2[i] = v + (dv*Lv + u*v*v - (f+k)*v);
      }
      U=U2; V=V2;
    }
    function draw(){
      const d = imageData.data;
      const kTone = 3.0;
      const norm = x => Math.max(0, Math.min(1, x));
      const tone = x => (1 - Math.exp(-kTone*x))/(1 - Math.exp(-kTone));
      for (let i=0;i<U.length;i++){
        const base = norm((U[i]-V[i])*1.0);
        const t = tone(base);
        const capped = Math.min(t,0.92);
        const c = (capped*255)|0;
        const p=i*4;
        d[p]=d[p+1]=d[p+2]=c; d[p+3]=255;
      }
      ctx.putImageData(imageData,0,0);
    }
    function loop(){
      if (!paused){
        let speed=3;
        if (playing && meyda?._features?.rms)
          speed=Math.min(10,Math.floor(3+meyda._features.rms*20));
        for (let i=0;i<speed;i++) step();
      }
      if (canvasActivated) draw();
      requestAnimationFrame(loop);
    }
    loop();

    canvas.addEventListener('click',()=>{
      flashFeed = 0.02;
      flashKill = -0.01;
    });

    // ... (省略: audio, folder selection, wake lock, dimming etc. 同じ仕組みを維持)
  </script>
</body>
</html>
