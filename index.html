<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>Gray-Scott Visualizer — AudioElement Fallback</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icon-192.png" type="image/png">
  <meta name="theme-color" content="#000000">
  <style>
    html, body { height: 100%; }
    body { margin: 0; background: #000; color: #fff; font-family: system-ui, sans-serif;
           display: flex; flex-direction: column; align-items: center; padding: 16px; }
    canvas { background: #000; width: 100%; max-width: 500px; aspect-ratio: 1 / 1;
             border-radius: 6px; opacity: 0; transition: opacity 0.8s ease; pointer-events: none; }
    canvas.active { opacity: 1; pointer-events: auto; }
    #controls { display: flex; flex-direction: column; align-items: stretch; width: 100%;
                max-width: 500px; margin-top: 16px; gap: 8px; }
    #lcd, button { height: 48px; background: #111; border: 1px solid #444; color: #fff;
                   font-size: 16px; font-family: monospace; display: flex; align-items: center;
                   justify-content: center; white-space: nowrap; cursor: pointer; padding: 0 12px;
                   border-radius: 8px; overflow: hidden; text-overflow: ellipsis; }
    #lcd strong { color: #0fd; }
    #lcd small { opacity: .7; margin-left: 8px; font-size: 12px; }
    #lcd span { display: inline-block; animation: scroll 12s linear infinite; }
    @keyframes scroll { from { transform: translateX(100%); } to { transform: translateX(-100%); } }
    input[type="file"] { display: none; }
    audio { display:none; }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <div id="controls">
    <div id="lcd"><span>NO FILES LOADED</span></div>
    <button id="folderButton">SELECT MUSIC FOLDER / FILES</button>
    <button id="playButton">PLAY</button>
    <button id="pauseButton">PAUSE</button>
    <button id="skipButton">NEXT</button>
    <button id="backButton">PREVIOUS</button>
    <input type="file" id="audioInput" accept="audio/*" multiple webkitdirectory>
  </div>
  <audio id="player" preload="metadata" playsinline></audio>

  <script src="https://cdn.jsdelivr.net/npm/meyda/dist/web/meyda.min.js"></script>
  <script>
    /* ===== Visualizer (same as before) ===== */
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const size = 500; canvas.width = canvas.height = size;
    const imageData = ctx.createImageData(size, size);
    let canvasActivated = false;

    let U = new Float32Array(size * size).fill(1);
    let V = new Float32Array(size * size).fill(0);
    for (let y = size/2-16; y < size/2+16; y++) for (let x = size/2-16; x < size/2+16; x++) V[y*size+x] = 1;

    const du=0.16, dv=0.08; let flashFeed=0, flashKill=0;
    const pink = Array(8).fill(0);
    const pn = () => { let t=0; for(let i=0;i<pink.length;i++){ if(Math.random()<1/(1<<i)) pink[i]=Math.random()*2-1; t+=pink[i]; } return t/pink.length; };
    const lap=(f,x,y)=>f[((y-1+size)%size)*size+x]+f[((y+1)%size)*size+x]+f[y*size+((x-1+size)%size)]+f[y*size+((x+1)%size)]-4*f[y*size+x];
    function step(){ const U2=new Float32Array(U.length), V2=new Float32Array(V.length); const t=performance.now()/1000;
      const f=0.022 + pn()*0.0015 + 0.0007*Math.sin(t*Math.PI/10) + flashFeed;
      const k=0.051 + pn()*0.0015 + 0.0007*Math.cos(t*Math.PI/10) + flashKill;
      flashFeed*=0.85; flashKill*=0.85;
      for(let i=0;i<U.length;i++){ const y=(i/size)|0, x=i%size; const u=U[i], v=V[i];
        const Lu=lap(U,x,y)*1.2, Lv=lap(V,x,y)*1.2; U2[i]=u+(du*Lu-u*v*v+f*(1-u)); V2[i]=v+(dv*Lv+u*v*v-(f+k)*v); }
      U=U2; V=V2;
    }
    function draw(){ const d=imageData.data, k=3; const n=x=>Math.max(0,Math.min(1,x)), t=x=>(1-Math.exp(-k*x))/(1-Math.exp(-k));
      for(let i=0;i<U.length;i++){ const c=(Math.min(t(n((U[i]-V[i])*1.0)),0.92)*255)|0; const p=i*4; d[p]=d[p+1]=d[p+2]=c; d[p+3]=255; }
      ctx.putImageData(imageData,0,0);
    }
    (function loop(){ for(let i=0;i<3;i++) step(); draw(); requestAnimationFrame(loop); })();
    canvas.addEventListener('click',()=>{ flashFeed=0.02; flashKill=-0.01; });

    /* ===== Audio via <audio> element ===== */
    const player = document.getElementById('player');
    let audioCtx, mediaSrc, analyser, meyda, gain;
    function ensureCtx(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        gain = audioCtx.createGain(); gain.gain.value = 1.0; gain.connect(audioCtx.destination);
        mediaSrc = audioCtx.createMediaElementSource(player); mediaSrc.connect(gain);
        analyser = audioCtx.createAnalyser(); analyser.fftSize = 1024;
        mediaSrc.connect(analyser);
        meyda = Meyda.createMeydaAnalyzer({ audioContext: audioCtx, source: analyser, bufferSize: 512, featureExtractors:['rms','spectralCentroid'], callback:()=>{} });
        try{ meyda.start(); }catch{}
      }
    }

    let playlist=[], urls=[], current=0;
    let autoPaused=false;

    const lcdSpan = document.querySelector('#lcd span');
    const lcd = t => (lcdSpan.innerHTML = t);
    const nowText = () => playlist.length ? `TRACK ${current+1}/${playlist.length}: ${playlist[current].name}` : 'NO FILES';

    function sortNumeric(files){
      return files.sort((a,b)=>{
        const ra=a.name.match(/\d+/), rb=b.name.match(/\d+/);
        if(ra&&rb){ const na=+ra[0], nb=+rb[0]; if(na!==nb) return na-nb; }
        else if(ra&&!rb) return -1; else if(!ra&&rb) return 1;
        return a.name.localeCompare(b.name,'ja',{numeric:true,sensitivity:'base'});
      });
    }

    function revokeAll(){ urls.forEach(u=>URL.revokeObjectURL(u)); urls=[]; }
    async function replacePlaylist(files,label=''){
      player.pause(); autoPaused=false; revokeAll();
      playlist = sortNumeric(files.filter(f => (f.type && f.type.startsWith('audio/')) || /\.(mp3|m4a|aac|wav|flac|ogg)$/i.test(f.name)));
      urls = playlist.map(f=>URL.createObjectURL(f));
      current = 0; player.src=''; lcd(playlist.length?`LOADED ${playlist.length} files${label?' — '+label:''}`:'NO FILES');
    }

    function play(index=current){
      if(!playlist.length) return;
      ensureCtx();
      current = Math.max(0, Math.min(index, playlist.length-1));
      player.src = urls[current];
      player.currentTime = (autoPaused ? player.currentTime : 0) || 0; // resume where it was if autoPaused retained state
      player.play().then(()=>{
        autoPaused=false; lcd(nowText());
        if(!canvasActivated){ canvas.classList.add('active'); canvasActivated=true; }
        audioCtx.resume().catch(()=>{});
      }).catch(err=>{
        // Need gesture — show hint
        lcd(`TAP TO <strong>RESUME</strong> — ${nowText()}`);
        const once = ()=>{ document.removeEventListener('touchstart', once); document.removeEventListener('click', once);
          player.play().then(()=>{ autoPaused=false; lcd(nowText()); }).catch(()=>{}); };
        document.addEventListener('touchstart', once, { once:true });
        document.addEventListener('click', once, { once:true });
      });
    }
    function pauseManual(){ player.pause(); autoPaused=false; lcd(`PAUSED — ${nowText()}`); }

    // events
    player.addEventListener('ended', ()=>{ play((current+1)%playlist.length); });

    // UI
    const folderButton=document.getElementById('folderButton');
    const audioInput=document.getElementById('audioInput');
    document.getElementById('playButton').addEventListener('click', ()=> play(current));
    document.getElementById('pauseButton').addEventListener('click', pauseManual);
    document.getElementById('skipButton').addEventListener('click', ()=>{ play((current+1)%playlist.length); });
    document.getElementById('backButton').addEventListener('click', ()=>{ play((current-1+playlist.length)%playlist.length); });

    async function* walk(h){ for await (const [name,e] of h.entries()){ if(e.kind==='file') yield await e.getFile(); else if(e.kind==='directory') yield* walk(e);} }
    async function loadFromDir(h){ const files=[]; for await(const f of walk(h)) files.push(f); await replacePlaylist(files, h?.name||''); }
    async function pickFolderNative(){ const h=await window.showDirectoryPicker({mode:'read'}); const p=await h.requestPermission({mode:'read'}); if(p!=='granted') throw new DOMException('Permission denied'); await loadFromDir(h); }

    folderButton.addEventListener('click', async (e)=>{
      e.preventDefault(); e.stopPropagation();
      requestWakeLock();
      try { if('showDirectoryPicker' in window){ await pickFolderNative(); } else { audioInput.click(); } }
      catch(err){ console.warn('Picker failed',err); audioInput.click(); }
    });
    audioInput.addEventListener('change', async (e)=>{
      const files = Array.from(e.target.files||[]);
      await replacePlaylist(files);
    });

    // background -> foreground
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState==='hidden'){ if(!player.paused){ autoPaused=true; player.pause(); lcd('PAUSED (background)'); } }
      if(document.visibilityState==='visible'){ if(autoPaused){ play(current); } }
    });
    window.addEventListener('pagehide', ()=>{ if(!player.paused){ autoPaused=true; player.pause(); lcd('PAUSED (background)'); } });

    /* Wake Lock */
    let wakeLock=null, wakeRetry=null;
    async function requestWakeLock(){ try{ if(!('wakeLock' in navigator)) return; if(wakeLock) return;
      wakeLock=await navigator.wakeLock.request('screen');
      if(!document.querySelector('#lcd small')) lcdSpan.insertAdjacentHTML('beforeend','<small>• screen on</small>');
      wakeLock.addEventListener('release',()=>{ wakeLock=null; clearTimeout(wakeRetry); wakeRetry=setTimeout(()=>{requestWakeLock();},500); });
    }catch(e){ clearTimeout(wakeRetry); wakeRetry=setTimeout(()=>{requestWakeLock();},1000); } }
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') requestWakeLock(); });
    ['click','touchstart'].forEach(ev=>document.addEventListener(ev,requestWakeLock,{once:true}));

    /* SW */
    if('serviceWorker' in navigator){ addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js?ver=24').catch(console.error); }); }
  </script>
</body>
</html>
